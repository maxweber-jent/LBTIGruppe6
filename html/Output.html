<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gruppe 6: Temperatur (Andere Schulen)</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        .chart-container {
            width: 80%;
            max-width: 900px;
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
        }
        .chart-title {
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
<h1>Serverraum-Überwachung: Temperatur (Andere Schulen)</h1>
<p>Zeigt die Temperaturdaten von Serverräumen der Alfons-Kern-Schule, Johanna-Wittum-Schule und Hochschule Pforzheim.</p>
<div id="charts-container"></div>
<script>
    const MQTT_BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
    const SUBSCRIBE_TOPIC = 'schule/+/+/+/+/temperatur';
    const schoolData = {};
    const CHART_OPTIONS = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                title: { display: true, text: 'Zeit' },
                type: 'time',
                time: { unit: 'minute', displayFormats: { minute: 'HH:mm' } },
                ticks: { source: 'auto' }
            },
            y: {
                title: { display: true, text: 'Temperatur (°C)' },
                min: 15,
                max: 30
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y + '°C';
                    }
                }
            }
        }
    };
    const client = mqtt.connect(MQTT_BROKER_URL);
    client.on('connect', () => {
        client.subscribe(SUBSCRIBE_TOPIC, { qos: 2 });
    });
    client.on('message', (topic, message) => {
        try {
            const payload = JSON.parse(message.toString());
            if (payload.location && payload.room && typeof payload.value === 'number' && payload.unit === '°C' && payload.timestamp) {
                const schoolName = payload.location;
                const roomName = payload.room;
                const fullLocationName = `${schoolName} - ${roomName}`;
                const otherSchools = ["Alfons-Kern-Schule", "Johanna-Wittum-Schule", "Hochschule Pforzheim"];
                if (!otherSchools.includes(schoolName)) return;
                const temperature = payload.value;
                const timestamp = new Date(payload.timestamp * 1000);
                if (!schoolData[fullLocationName]) {
                    schoolData[fullLocationName] = {
                        labels: [],
                        data: [],
                        chart: null
                    };
                    createChartForLocation(fullLocationName);
                }
                const locationData = schoolData[fullLocationName];
                locationData.labels.push(timestamp);
                locationData.data.push(temperature);
                const MAX_DATA_POINTS = 60;
                if (locationData.labels.length > MAX_DATA_POINTS) {
                    locationData.labels.shift();
                    locationData.data.shift();
                }
                if (locationData.chart) {
                    locationData.chart.update();
                }
            }
        } catch (e) {}
    });
    function createChartForLocation(locationName) {
        const container = document.getElementById('charts-container');
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container';
        chartDiv.id = `chart-${locationName.replace(/\s/g, '-')}`;
        container.appendChild(chartDiv);
        const title = document.createElement('div');
        title.className = 'chart-title';
        title.textContent = `Temperatur: ${locationName}`;
        chartDiv.appendChild(title);
        const canvas = document.createElement('canvas');
        canvas.id = `canvas-${locationName.replace(/\s/g, '-')}`;
        chartDiv.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        const locationData = schoolData[locationName];
        locationData.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: locationData.labels,
                datasets: [{
                    label: 'Temperatur (°C)',
                    data: locationData.data,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: CHART_OPTIONS
        });
    }
</script>
</body>
</html>
